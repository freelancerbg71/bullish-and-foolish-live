<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/webp" href="/assets/images/bullfavicon.webp">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <title id="metaTitle">Stock Analysis | Bullish and Foolish</title>
    <meta id="metaDesc" name="description"
        content="Fundamental analysis and quality score powered by SEC filings. View profitability, growth, and solvency metrics.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://bullishandfoolish.com/ticker.html">
    <meta property="og:title" content="Stock Analysis | Bullish and Foolish">
    <meta property="og:site_name" content="Bullish And Foolish Stock Analysis">
    <meta property="og:description"
        content="Fundamental analysis and quality score powered by SEC filings. Profitability, growth, solvency metrics and filing intelligence.">
    <meta property="og:image" content="https://bullishandfoolish.com/assets/images/bullishandfoolish.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Stock Analysis | Bullish and Foolish">
    <meta name="twitter:description"
        content="Fundamental analysis and quality score powered by SEC filings. Profitability, growth, solvency metrics and filing intelligence.">
    <meta name="twitter:image" content="https://bullishandfoolish.com/assets/images/bullishandfoolish.png">

    <link rel="stylesheet" href="/style.css?v=20260104.2">
    <style>
        .pillar-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-xl);
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border);
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .warning-panel {
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: var(--space-md);
            margin: var(--space-md) 0 var(--space-lg);
        }

        .warning-panel-title {
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            color: var(--text-muted);
            margin-bottom: var(--space-sm);
        }

        .warning-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: var(--space-md);
        }

        .confidence-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 10px;
            padding: 6px 8px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(148, 163, 184, 0.08);
        }

        .confidence-meter {
            height: 4px;
            width: 80px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            overflow: hidden;
        }

        .confidence-meter-fill {
            height: 100%;
            width: 0%;
            background: var(--text-muted);
            transition: width 0.4s ease;
        }

        #loadingStatus {
            transition: opacity 0.6s ease;
        }

        .confidence-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            line-height: 1.2;
        }

        .warning-item {
            border-radius: 10px;
            padding: 10px 12px;
            border: 1px solid rgba(255, 155, 27, 0.3);
            background: rgba(255, 155, 27, 0.08);
        }

        .warning-item-title {
            color: #ff9b1b;
            font-weight: 700;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .warning-item-text {
            color: var(--text);
            opacity: 0.85;
            font-size: 0.82rem;
            line-height: 1.35;
        }

        .dq-badge {
            display: inline-block;
            margin-top: 6px;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            color: #d97706;
            background: rgba(255, 165, 0, 0.12);
            border: 1px solid rgba(255, 165, 0, 0.25);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: var(--space-xl) auto;
        }

        .scroll-down-overlay {
            position: fixed;
            left: 50%;
            bottom: 18px;
            transform: translateX(-50%) translateY(6px);
            width: 44px;
            height: 44px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.35);
            background: rgba(15, 23, 42, 0.72);
            color: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.35s ease, transform 0.35s ease;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.35);
            z-index: 50;
        }

        .scroll-down-overlay::before {
            content: "";
            position: absolute;
            inset: 8px;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.25);
        }

        .scroll-down-overlay.is-visible {
            opacity: 0.92;
            transform: translateX(-50%) translateY(0);
        }

        @media (min-width: 721px) {
            .scroll-down-overlay {
                display: none;
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-GFS8VB2GT4"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-GFS8VB2GT4');
    </script>
</head>

<body>

    <header class="app-header">
        <div class="header-content">
            <a href="/index.html" class="header-brand header-left">
                Bullish <span style="color: var(--accent); font-style: italic;">&</span> Foolish
            </a>
            <div class="header-ticker-info">
                <div id="tickerDisplay">--</div>
                <div id="nameDisplay" class="text-muted">--</div>
            </div>
            <div class="header-right"
                style="display: flex; align-items: center; gap: var(--space-lg); justify-self: end;">
                <div id="stickyScoreContainer" class="sticky-score">
                    <span class="label" style="font-size: 0.7rem;">Score</span>
                    <span id="headerScore" style="font-weight: 800; font-size: 1.1rem;">--</span>
                </div>
                <nav class="header-nav text-muted">
                    <a href="/screener.html">Screener</a>
                    <a href="/articles.html">Articles</a>
                    <a href="/about.html">Methodology</a>
                    <a href="/index.html">Search</a>
                    <div id="authButtonContainer"></div>
                </nav>
            </div>
        </div>
    </header>

    <main class="container">
        <h1 id="pageTitle" class="page-title visually-hidden"
            style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">Stock Analysis</h1>
        <!-- Loading State -->
        <div id="loading" class="section" style="text-align: center; padding-top: 10vh;">
            <div id="scanningNotice"
                style="font-size: 1.1rem; color: var(--text-primary); margin-bottom: 10px; display: block;">
                Deep Scanning SEC Filings (this can take 10-15 seconds)...
            </div>
            <div class="label" style="font-size: 0.95rem; letter-spacing: 0.05em; color: var(--text-muted);"
                id="loadingStatus">
                Assembling Financial Data...
            </div>
            <div class="spinner" style="margin-top: 24px;"></div>
        </div>

        <div id="content" style="display: none;">
            <!-- Hero Rating Section -->
            <section class="section mobile-hero-layout"
                style="border-bottom: 1px solid var(--border); display: flex; gap: var(--space-2xl); align-items: flex-start;">
                <div class="mobile-hero-sidebar"
                    style="flex-shrink: 0; text-align: center; width: 180px; position: sticky; top: 100px;">
                    <div class="rating-group">
                        <img id="ratingIcon" class="bull-icon-large mobile-bull-icon" alt="Rating Icon">
                        <div id="tierBadge" class="badge"
                            style="display: block; width: 100%; padding: 8px; font-size: 0.85rem; margin-top: 10px; margin-bottom: 20px;">
                            --
                        </div>
                    </div>

                    <div class="hero-stats-container mobile-hero-stats"
                        style="flex-direction: column; align-items: center; text-align: center;">
                        <div class="hero-stat-item">
                            <div class="hero-stat-label">Quality Score</div>
                            <div id="scoreDisplay" class="hero-stat-value">--</div>
                            <div id="pastRatingMeta" class="text-muted" style="margin-top: 8px; display: none;"></div>
                            <div style="font-size: 0.65rem; margin-top: 8px; font-weight: 500; line-height: 1.3;">
                                Find this useful? <br>
                                <a href="javascript:void(0)" onclick="showSupportModal()"
                                    style="color: var(--accent); text-decoration: none; font-weight: 700;">Support the
                                    project -></a>
                            </div>
                        </div>
                        <div class="hero-stat-item">
                            <div class="hero-stat-label">Last Price</div>
                            <div id="priceDisplay" class="hero-stat-value" style="font-size: 1.25rem;">--</div>
                        </div>
                    </div>
                </div>
                <div style="flex-grow: 1;">
                    <div class="label" style="margin-bottom: var(--space-md);">Strategic Financial Narrative</div>
                    <div class="narrative-container">
                        <div id="narrativeDisplay" class="narrative-text">
                            Loading narrative...
                        </div>
                    </div>

                    <!-- Risk Alerts Box (clickable, leads to Filing Intelligence) -->
                    <div id="riskAlertsBox" class="card"
                        style="margin-top: var(--space-md); padding: var(--space-md); display: none; background: rgba(255, 80, 80, 0.08); border: 1px solid rgba(255, 80, 80, 0.3); cursor: pointer;"
                        onclick="document.getElementById('filingIntelligenceSection').scrollIntoView({behavior: 'smooth'});">
                        <div style="display: flex; align-items: center; gap: var(--space-sm);">
                            <span style="font-size: 1.25rem;">&#9888;</span>
                            <span class="label" style="font-size: 0.8rem; color: var(--negative);">Risk Alerts
                                Detected</span>
                        </div>
                        <p id="riskAlertsText"
                            style="font-size: 0.9rem; line-height: 1.5; margin: var(--space-sm) 0 0 0; color: var(--text-muted);">
                        </p>
                        <div style="font-size: 0.75rem; color: var(--accent); margin-top: var(--space-sm);">Click to
                            view Filing Signals -></div>
                    </div>

                    <!-- View on Screener Link -->
                    <div id="screenerLinkContainer" style="margin-top: var(--space-md); display: none;">
                        <a id="screenerLink" href="/screener.html"
                            style="display: inline-flex; align-items: center; gap: 8px; color: var(--accent); text-decoration: none; font-size: 0.85rem; font-weight: 500;">
                            <span>View peers on Screener -></span>
                        </a>
                    </div>

                    <div id="warningPanel" class="warning-panel" style="display: none;">
                        <div class="warning-panel-title">Alerts &amp; Data Quality</div>
                        <div id="warningItems" class="warning-items"></div>
                        <div id="confidencePill" class="confidence-pill"
                            style="display: none; margin-top: var(--space-md);">
                            <div>
                                <div id="confidenceText" class="confidence-text">Confidence: n/a</div>
                            </div>
                            <div class="confidence-meter" aria-hidden="true">
                                <div id="confidenceFill" class="confidence-meter-fill"></div>
                            </div>
                        </div>
                    </div>
                    <div style="height: var(--space-lg);"></div>
                    <div id="quickHighlights" class="grid grid-3">
                        <!-- Points Cards will be injected here -->
                    </div>
                </div>
        </div>
        </section>

        <!-- Signals -->
        <section id="filingIntelligenceSection" class="section"
            style="margin-bottom: var(--space-2xl); border-bottom: 1px solid var(--border);">
            <div class="label" style="margin-bottom: var(--space-lg);">Filing Text Signals</div>
            <div id="filingSignalsContainer" class="grid grid-2">
                <!-- Skeleton Layover -->
                <div class="card skeleton skeleton-card"></div>
                <div class="card skeleton skeleton-card"></div>
            </div>
        </section>
        <section id="bioIntelSection" class="section" style="margin-bottom: var(--space-2xl); display: none;">
            <div class="label" style="margin-bottom: var(--space-lg);">Biotech Intelligence</div>
            <div id="bioIntelContainer" class="grid grid-2">
                <!-- Biotech signals will be injected here -->
            </div>
        </section>

        <!-- The Pillars (Reorganized) -->
        <section class="section">
            <div class="pillar-grid">
                <!-- Strategic Outlook -->
                <div class="card" style="grid-column: span 2;">
                    <div class="pillar-title">Strategic Outlook</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-lg);">
                        <!-- Operational Momentum -->
                        <div class="hero-stat-item" style="border: none;">
                            <div class="hero-stat-label" style="font-size: 0.8rem;">Operational Momentum</div>
                            <div id="opMomentum" style="font-size: 1.2rem; font-weight: 700; margin-top: 8px;">--
                            </div>
                            <div id="opMomentumDesc" class="text-muted"
                                style="font-size: 0.8rem; margin-top: 4px; min-height: 2.4em;">--</div>
                            <div class="momentum-track">
                                <div id="opMomentumBar"
                                    style="width: 0%; height: 100%; background: var(--text-muted); transition: width 0.5s ease;">
                                </div>
                            </div>
                        </div>
                        <!-- Trajectory -->
                        <div class="hero-stat-item" style="border: none;">
                            <div class="hero-stat-label" style="font-size: 0.8rem;">Trajectory</div>
                            <div
                                style="font-size: 1.1rem; margin-top: 8px; line-height: 1.4; display: flex; align-items: center; gap: 8px;">
                                <div id="trajIcon" style="font-size: 1.2rem;"></div>
                                <span id="trajLabel" style="font-weight: 800; display: block;">--</span>
                            </div>
                            <span id="trajText" class="text-muted"
                                style="font-size: 0.9rem; margin-top: 4px; display: block;">--</span>
                            <details id="trajHint" class="trajectory-hint">
                                <summary>
                                    <span class="traj-hint-label">Trajectory:</span>
                                    <span id="trajHintLabel">--</span>
                                    <span class="traj-hint-why">(why?)</span>
                                </summary>
                                <div id="trajHintBody" class="text-muted"></div>
                            </details>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="relatedArticlesSection" class="section"
            style="margin-bottom: var(--space-3xl); display: none; border-top: 1px solid var(--border); padding-top: var(--space-2xl);">
            <div style="display: flex; align-items: baseline; gap: 18px; flex-wrap: wrap; margin-bottom: var(--space-lg);">
                <div class="label" style="font-size: 0.75rem; letter-spacing: 0.22em; color: var(--accent);">
                    RESEARCH MEMO
                </div>
                <div style="font-family: var(--font-serif); font-size: 2rem; font-weight: 800;">
                    Read the story behind the filings
                </div>
            </div>
            <div class="text-muted" style="margin-bottom: var(--space-xl); max-width: 720px; font-size: 1.05rem;">
                Long-form analysis with context, narrative, and the data that moves the needle.
            </div>
            <div id="relatedArticlesContainer" class="grid grid-2" style="gap: var(--space-xl);"></div>
        </section>

        </div>
    </main>




    <script>
        function showSupportModal() {
            document.getElementById('supportModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        function closeSupportModal(e) {
            document.getElementById('supportModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        const loadingMessages = [
            "Loading fundamentals and prices…",
            "Checking filing signals for recent 10-K/10-Q/8-K mentions…",
            "Computing quality score from fundamentals…",
            "Summarizing the strategic narrative…",
            "Measuring operational momentum and trajectory…"
        ];
        let narratorTimer = null;
        let narratorIndex = 0;

        function startLoadingNarrator() {
            const label = document.getElementById('loadingStatus');
            if (!label) return;
            stopLoadingNarrator();
            const setText = (text) => {
                label.style.opacity = 0;
                setTimeout(() => {
                    label.textContent = text;
                    label.style.opacity = 1;
                }, 250);
            };

            narratorIndex = 0;
            const loop = () => {
                const next = loadingMessages[narratorIndex % loadingMessages.length];
                setText(next);
                narratorIndex += 1;
                narratorTimer = setTimeout(loop, 1500 + Math.random() * 500); // 1.5s - 2.0s
            };
            loop();
        }

        function stopLoadingNarrator(finalText = null) {
            if (narratorTimer) {
                clearTimeout(narratorTimer);
                narratorTimer = null;
            }
            if (finalText) {
                const label = document.getElementById('loadingStatus');
                if (label) {
                    label.style.opacity = 1;
                    label.textContent = finalText;
                }
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const tickerParam = urlParams.get('ticker')?.toUpperCase();
        const refreshParam = urlParams.get('refresh');

        let ticker = tickerParam;
        if (!ticker) {
            const parts = window.location.pathname.split('/').filter(Boolean);
            if (parts.length === 2 && parts[0].toLowerCase() === 'ticker') {
                ticker = decodeURIComponent(parts[1]).toUpperCase();
            }
        }

        if (tickerParam && !window.location.pathname.startsWith('/ticker/')) {
            // Server handles 301 redirect - client-side disabled for SEO
            console.log('Legacy URL format detected - server should have redirected');
        }

        const ruleExplainers = {
            "Revenue growth YoY": { pos: "Sales are growing vs last year.", neg: "Sales are shrinking vs last year." },
            "Revenue growth": { pos: "Sales are growing vs last year.", neg: "Sales are shrinking vs last year." },
            "Revenue Growth": { pos: "Sales are growing vs last year.", neg: "Sales are shrinking vs last year." },
            "Gross margin": { pos: "Gross profit as % of revenue (higher is better).", neg: "Low gross profit % of revenue." },
            "FCF margin": { pos: "TTM free cash flow as % of revenue (higher is better).", neg: "TTM free cash flow is weak vs revenue." },
            "Cash Runway (years)": { pos: "Enough cash for the long haul.", neg: "Might need more funding soon." },
            "Shares dilution YoY": { pos: "Share count is stable.", neg: "New shares reduce your ownership." },
            "Share Buybacks": { pos: "Company is repurchasing its own stock.", neg: "Shares are being diluted." },
            "Debt / Equity": { pos: "Latest total debt relative to equity (lower is safer).", neg: "High debt relative to equity." },
            "Net Debt / FCF": { pos: "Net debt relative to TTM FCF (lower is safer).", neg: "Debt burden is heavy vs cash flow." },
            "Interest coverage": { pos: "TTM operating income / interest expense (higher is safer).", neg: "TTM operating income doesn't cover interest." },
            "ROIC": { pos: "Creating value on every dollar invested.", neg: "Low returns on invested capital." },
            "ROE": { pos: "Efficiently using shareholder money.", neg: "Low return on equity." },
            "ROE quality": { pos: "Return on equity driven by efficiency.", neg: "Return on equity boosted by debt." },
            "Refined ROE": { pos: "High quality returns.", neg: "Weak returns on capital." },
            "Revenue CAGR (3Y)": { pos: "3-year annualized revenue growth is strong.", neg: "3-year annualized revenue growth is weak." },
            "EPS CAGR (3Y)": { pos: "3-year annualized EPS growth is strong.", neg: "3-year annualized EPS growth is weak." },
            "R&D intensity": { pos: "Investing heavily in the future.", neg: "Spending little on innovation." },
            "Working Capital": { pos: "Efficient cash cycle.", neg: "Cash cycle is inefficient/strapped." },
            "Operating leverage": { pos: "TTM operating income relative to gross profit is improving.", neg: "TTM operating income is weak vs gross profit." },
            "Price / Sales": { pos: "Price vs TTM revenue (lower can be cheaper).", neg: "Price is high vs TTM revenue." },
            "Price / Earnings": { pos: "Price vs TTM earnings (lower can be cheaper).", neg: "Price is high vs TTM earnings." },
            "Price / Book": { pos: "Price vs book value per share (lower can be cheaper).", neg: "Price is high vs book value." },
            "Asset Efficiency": { pos: "Generating strong turnover on assets.", neg: "Assets are underutilized." },
            "Revenue per Asset Efficiency": { pos: "Getting more revenue out of every asset.", neg: "Asset yield is declining." },
            "Revenue Per Asset Efficiency": { pos: "Getting more revenue out of every asset.", neg: "Asset yield is declining." },
            "Revenue Quality": { pos: "Growth backed by cash collection.", neg: "Growth relies on uncollected IOU sales." },
            "Effective Tax Rate": { pos: "Tax rate implies normal operations.", neg: "Tax rate suggests unusual items." },
            "Return on Assets": { pos: "Profitable relative to total assets.", neg: "Low profit relative to asset base." },
            "Gross margin trend": { pos: "Gross margin is expanding vs last year.", neg: "Gross margin is compressing vs last year." },
            "Capital Return": { pos: "Buybacks + dividends as % of TTM FCF are strong.", neg: "Shareholder returns are limited vs FCF." },
            "Capital Return TTM": { pos: "Buybacks + dividends as % of TTM FCF are strong.", neg: "Shareholder returns are limited vs FCF." },
            "Debt Maturity Runway": { pos: "No major debt due soon.", neg: "Significant debt maturing shortly." },
            "Net income trend": { pos: "Profits are trending up.", neg: "Profits are shrinking." },
            "Operating Leverage Inflection": { pos: "Operating leverage is improving.", neg: "Operating leverage is weakening." },
            "Asset Growth Velocity": { pos: "Assets are scaling quickly.", neg: "Asset growth is slowing." }
        };

        function initScrollCue() {
            const overlay = document.getElementById('scrollDownOverlay');
            if (!overlay) return;
            const isMobile = window.matchMedia('(max-width: 720px)').matches;
            if (!isMobile) {
                overlay.classList.remove('is-visible');
                return;
            }

            overlay.classList.add('is-visible');

            const onScroll = () => {
                if (window.scrollY > 10) {
                    overlay.classList.remove('is-visible');
                    window.removeEventListener('scroll', onScroll);
                    window.removeEventListener('touchstart', onTouchStart);
                }
            };

            const onTouchStart = () => {
                overlay.classList.remove('is-visible');
                window.removeEventListener('scroll', onScroll);
                window.removeEventListener('touchstart', onTouchStart);
            };

            window.addEventListener('scroll', onScroll, { passive: true });
            window.addEventListener('touchstart', onTouchStart, { passive: true });
        }

        function formatPct(val, multiply = true) {
            if (val == null) return '--';
            const n = Number(val) * (multiply ? 100 : 1);
            return n.toFixed(1) + '%';
        }

        function formatNum(val, dec = 2) {
            if (val == null) return '--';
            return Number(val).toFixed(dec);
        }

        function formatScore(val, dec = 2) {
            if (val == null) return '--';
            const num = Number(val);
            if (!Number.isFinite(num)) return '--';
            if (Math.abs(num - Math.round(num)) < 1e-6) return String(Math.round(num));
            return num.toFixed(dec);
        }
        // Detect non-SEC-filing tickers (warrants, units, rights, preferred shares, etc.)
        function isNonFilingTicker(tickerSymbol) {
            const t = tickerSymbol.toUpperCase();
            // Warrants: -WT, -WS, +, ends with W after 4+ chars
            if (/-WT$|-WS$/.test(t)) return { type: 'warrant', baseTicker: t.replace(/-WT$|-WS$/g, '') };
            if (/\+$/.test(t)) return { type: 'warrant', baseTicker: t.replace(/\+$/g, '') };
            if (t.length >= 5 && /W$/.test(t) && !/^[A-Z]{1,4}W$/.test(t)) return { type: 'warrant', baseTicker: t.replace(/W$/g, '') };
            // Units: -UN, -U, ends with U after base ticker
            if (/-UN$|-U$/.test(t)) return { type: 'unit', baseTicker: t.replace(/-UN$|-U$/g, '') };
            if (t.length >= 5 && /U$/.test(t) && !/^[A-Z]{1,4}U$/.test(t)) return { type: 'unit', baseTicker: t.replace(/U$/g, '') };
            // Rights: -R, -RT, ends with R after 4+ chars
            if (/-R$|-RT$/.test(t)) return { type: 'right', baseTicker: t.replace(/-R$|-RT$/g, '') };
            if (t.length >= 5 && /R$/.test(t) && !/^[A-Z]{1,4}R$/.test(t)) return { type: 'right', baseTicker: t.replace(/R$/g, '') };
            // Preferred shares: -PA, -PB, -PC, etc.
            if (/-P[A-Z]$/.test(t)) return { type: 'preferred', baseTicker: t.replace(/-P[A-Z]$/g, '') };
            // Notes: -N
            if (/-N$/.test(t)) return { type: 'note', baseTicker: t.replace(/-N$/g, '') };
            return null;
        }

        function renderUnsupportedTickerPage(tickerSymbol, info) {
            const typeLabels = {
                warrant: 'Warrant',
                unit: 'Unit',
                right: 'Right',
                preferred: 'Preferred Share',
                note: 'Note/Debenture'
            };
            const typeLabel = typeLabels[info.type] || 'Security';
            
            document.getElementById('loading').innerHTML = `
                <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 40px 20px;">
                    <div style="font-size: 3rem; margin-bottom: 20px;"></div>
                    <h2 style="font-size: 1.5rem; margin-bottom: 16px; color: var(--text-primary);">
                        ${tickerSymbol} is a ${typeLabel}
                    </h2>
                    <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 24px;">
                        This ticker represents a <strong>${typeLabel.toLowerCase()}</strong>, which does not file standard SEC financials (10-K / 10-Q). 
                        Bullish and Foolish analyzes <strong>common stocks</strong> that file regular quarterly and annual reports with the SEC.
                    </p>
                    ${info.baseTicker ? `
                        <div style="margin-bottom: 24px;">
                            <p style="color: var(--text-muted); margin-bottom: 12px;">Looking for the main stock?</p>
                            <a href="/ticker/${info.baseTicker}" class="btn" style="display: inline-flex; align-items: center; gap: 8px; background: var(--accent); color: var(--bg-primary); padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600;">
                                View ${info.baseTicker} Analysis
                            </a>
                        </div>
                    ` : ''}
                    <div style="border-top: 1px solid var(--border); padding-top: 20px; margin-top: 20px;">
                        <a href="/" style="color: var(--accent); text-decoration: none;">Back to Search</a>
                    </div>
                </div>
            `;
        }

        const relatedArticlesByTicker = {
            PLTR: [
                {
                    title: 'Palantir: The $80B Sci-Fi Story',
                    path: '/articles/palantir-sci-fi-reality.html',
                    description: 'A deep look at PLTR fundamentals beyond the hype.',
                    tag: 'Fundamental Research',
                    readTime: '6 min'
                }
            ],
            ACHR: [
                {
                    title: 'Flying Cars: Are Archer\'s Fundamentals Grounded?',
                    path: '/articles/archer-aviation-flying-cars.html',
                    description: 'What the filings say about Archer Aviation\'s runway.',
                    tag: 'Speculative Growth',
                    readTime: '5 min'
                }
            ],
            TSLA: [
                {
                    title: 'Tesla: Overvalued or Misunderstood?',
                    path: '/articles/tesla-overvalued-reality-check.html',
                    description: 'A reality check on TSLA fundamentals and risk.',
                    tag: 'Fundamental Analysis',
                    readTime: '6 min'
                }
            ],
            META: [
                {
                    title: 'Meta: Fundamental Reality Check',
                    path: '/articles/meta-fundamental-reality-check.html',
                    description: 'A closer read of META\'s balance sheet and signals.',
                    tag: 'Fundamental Analysis',
                    readTime: '6 min'
                }
            ],
            KULR: [
                {
                    title: 'The "Kiss of Death" Signature',
                    path: '/articles/going-concern.html',
                    description: 'Understanding going concern warnings through real filings.',
                    tag: 'Financial Intelligence',
                    readTime: '5 min'
                }
            ],
            BINI: [
                {
                    title: 'The "Kiss of Death" Signature',
                    path: '/articles/going-concern.html',
                    description: 'Understanding going concern warnings through real filings.',
                    tag: 'Financial Intelligence',
                    readTime: '5 min'
                }
            ]
        };

        function renderRelatedArticles(tickerSymbol) {
            const articles = relatedArticlesByTicker[tickerSymbol];
            if (!articles || articles.length === 0) return;
            const section = document.getElementById('relatedArticlesSection');
            const container = document.getElementById('relatedArticlesContainer');
            if (!section || !container) return;

            container.innerHTML = articles.map((article, index) => {
                const isFeature = index === 0 && articles.length > 1;
                const meta = [article.tag, article.readTime].filter(Boolean).join(' • ');

                return `
                <div class="card" style="${isFeature ? 'grid-column: span 2; border-left: 4px solid var(--accent);' : ''} background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.15)); padding: var(--space-xl); border: 1px solid var(--border); box-shadow: 0 14px 40px rgba(0, 0, 0, 0.18);">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 12px;">
                        <div class="label" style="font-size: 0.75rem; letter-spacing: 0.12em; color: var(--text-muted);">${article.tag || 'Research'}</div>
                        ${article.readTime ? `<div class="text-muted" style="font-size: 0.8rem;">${article.readTime} read</div>` : ''}
                    </div>
                    <div style="font-family: var(--font-serif); font-size: ${isFeature ? '1.6rem' : '1.35rem'}; font-weight: 700; margin-top: var(--space-sm);">
                        ${article.title}
                    </div>
                    <p class="text-muted" style="margin-top: var(--space-sm); font-size: 1rem; line-height: 1.6; max-width: ${isFeature ? '680px' : 'unset'};">
                        ${article.description}
                    </p>
                    <a href="${article.path}" style="margin-top: var(--space-md); display: inline-flex; align-items: center; gap: 10px; color: var(--accent); text-decoration: none; font-weight: 700;">
                        Read the memo <span aria-hidden="true">→</span>
                    </a>
                </div>
                `;
            }).join('');

            section.style.display = 'block';
        }


        async function init() {
            if (!ticker) {
                document.getElementById('loading').innerHTML = '<div class="badge badge-bearish">No Ticker Specified</div>';
                return;
            }
            // Check if this is a non-filing ticker BEFORE making API call
            const nonFilingInfo = isNonFilingTicker(ticker);
            if (nonFilingInfo) {
                renderUnsupportedTickerPage(ticker, nonFilingInfo);
                return;
            }
            renderRelatedArticles(ticker);


            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 35000); // 35s timeout for deep scans
                const refresh = urlParams.get('refresh') === 'true' ? '&refresh=true' : '';

                let res = await fetch(`/api/ticker?symbol=${ticker}${refresh}`, { signal: controller.signal });
                if (!res.ok) {
                    try {
                        await fetch(`/api/edgar-facts?ticker=${ticker}&mode=snapshot`, { signal: controller.signal });
                    } catch (err) {
                        console.warn('EDGAR fallback failed', err);
                    }
                    res = await fetch(`/api/ticker?symbol=${ticker}`, { signal: controller.signal });
                }
                clearTimeout(timeoutId);

                if (!res.ok) throw new Error('Ticker not found');
                const data = await res.json();

                // SEO & Schema Injection
                const pageTitle = `${data.ticker} Fundamental Analysis & Quality Rating | Bullish and Foolish`;
                document.title = pageTitle;
                const metaDesc = document.getElementById('metaDesc');
                if (metaDesc && data.strategicOutlook?.narrative) {
                    const snippet = data.strategicOutlook.narrative.split('.')[0] + '.';
                    metaDesc.setAttribute('content', `${data.ticker}: ${snippet} SEC-filing based fundamental score: ${data.ratingNormalizedScore ?? '--'}/100.`);
                }

                // JSON-LD Schema
                const schema = {
                    "@context": "https://schema.org",
                    "@type": "FinancialProduct",
                    "name": `${data.ticker} Stock Quality Analysis`,
                    "description": data.strategicOutlook?.narrative || pageTitle,
                    "brand": { "@type": "Brand", "name": "Bullish & Foolish" },
                    "identifier": data.ticker
                };
                let schemaScript = document.getElementById('jsonLdSchema');
                if (!schemaScript) {
                    schemaScript = document.createElement('script');
                    schemaScript.id = 'jsonLdSchema';
                    schemaScript.type = 'application/ld+json';
                    document.head.appendChild(schemaScript);
                }
                schemaScript.textContent = JSON.stringify(schema);

                // 1. Header & Meta
                document.getElementById('tickerDisplay').textContent = data.ticker;
                document.getElementById('nameDisplay').textContent = data.companyName || '';
                const pageTitleEl = document.getElementById('pageTitle');
                if (pageTitleEl) {
                    const companySegment = data.companyName ? ` (${data.companyName})` : '';
                    pageTitleEl.textContent = `${data.ticker}${companySegment} Stock Analysis`;
                }

                const score = data.ratingNormalizedScore;
                document.getElementById('scoreDisplay').textContent = score ?? '--';
                const scoreColor = score >= 70 ? 'var(--accent)' : (score < 40 ? 'var(--danger)' : 'var(--warning)');
                document.getElementById('scoreDisplay').style.color = scoreColor;
                const pastMeta = document.getElementById('pastRatingMeta');
                const past = data.pastRating || null;
                const delta = Number(data.pastRatingDelta);
                const isPos = delta > 0;
                const isNeg = delta < 0;
                const deltaClass = isPos ? 'positive' : (isNeg ? 'negative' : 'neutral');
                const deltaIcon = isPos ? '▲' : (isNeg ? '▼' : '');
                const deltaValue = Number.isFinite(delta) ? `${delta > 0 ? '+' : ''}${delta}` : '--';

                if (past && Number.isFinite(past.score) && past.periodStart && past.periodEnd) {
                    pastMeta.innerHTML = `
                        <div class="score-trend-container">
                            <div class="momentum-label">Quality Momentum</div>
                            <div class="momentum-pill">
                                <div class="momentum-score-comparison">
                                    <span class="prior-label">Prior Score</span>
                                    <span class="prior-value">${past.score}</span>
                                </div>
                                <div class="delta-badge ${deltaClass}">
                                    <span>${deltaIcon}</span>
                                    <span>${deltaValue}</span>
                                </div>
                            </div>
                            <div class="momentum-period">
                                Prior: ${past.periodStart} → ${past.periodEnd}
                            </div>
                        </div>
                    `;
                    pastMeta.style.display = 'block';
                } else {
                    pastMeta.style.display = 'none';
                }

                // Sync header score
                const headerScore = document.getElementById('headerScore');
                headerScore.textContent = score ?? '--';
                headerScore.style.color = scoreColor;

                // Bull Icon Selection
                const iconEl = document.getElementById('ratingIcon');
                if (score >= 70) iconEl.src = '/assets/images/bull.webp';
                else if (score >= 40) iconEl.src = '/assets/images/neutral.webp';
                else iconEl.src = '/assets/images/foolish.webp';

                const tierMap = {
                    'elite': 'Elite Fundamentals',
                    'bullish': 'Strong Fundamentals',
                    'solid': 'Solid / Reliable',
                    'mixed': 'Mixed Data',
                    'spec': 'Speculative / Volatile',
                    'danger': 'Distressed / Caution',
                    'incomplete': 'Data Incomplete',
                    'neutral': 'Mixed Data',
                    'bearish': 'Distressed / Caution'
                };
                const rawTier = (data.ratingTierLabel || 'N/A').toLowerCase();
                const baseTierLabel = tierMap[rawTier] || data.ratingTierLabel || 'N/A';
                const tierBadge = document.getElementById('tierBadge');

                const annualMode = Boolean(data.annualMode);

                const isBiotechSector = (() => {
                    const sector = String(data.sectorBucket || data.sector || '').toLowerCase();
                    const sicDesc = String(data.filingProfile?.sicDescription || '').toLowerCase();
                    const name = String(data.companyName || '').toLowerCase();
                    return sector.includes('biotech') ||
                        sector.includes('pharma') ||
                        sicDesc.includes('pharmaceutical') ||
                        sicDesc.includes('biological') ||
                        sicDesc.includes('medicinal') ||
                        /\b(therapeutics|biopharma|oncology|biosciences)\b/i.test(name);
                })();

                const isEstablishedPharma = (() => {
                    if (!isBiotechSector) return false;
                    const revenueTTM = Number(data.snapshot?.revenueTTM ?? data.keyMetrics?.revenueTTM ?? 0);
                    const netIncome = Number(data.snapshot?.netIncomeTTM ?? data.keyMetrics?.netIncome ?? 0);
                    const marketCap = Number(data.marketCap ?? data.snapshot?.marketCap ?? data.keyMetrics?.marketCap ?? 0);
                    return revenueTTM > 2_000_000_000 ||
                        (revenueTTM > 500_000_000 && netIncome > 0) ||
                        marketCap > 50_000_000_000;
                })();

                const isClinicalStageBiotech = isBiotechSector && !isEstablishedPharma;
                const tierLabel = isClinicalStageBiotech ? 'Trial Dependent' : baseTierLabel;

                tierBadge.textContent = tierLabel;
                tierBadge.className = `badge ${score >= 70 ? 'badge-bullish' : (score < 40 ? 'badge-bearish' : 'badge-neutral')}`;
                if (isClinicalStageBiotech) {
                    tierBadge.style.background = 'rgba(147, 51, 234, 0.15)';
                    tierBadge.style.color = '#c084fc';
                    tierBadge.title = 'Pre-revenue biotech - investment thesis depends on clinical trial outcomes.';
                } else {
                    tierBadge.style.background = '';
                    tierBadge.style.color = '';
                    tierBadge.title = '';
                }

                const price = data.priceSummary?.lastClose;
                document.getElementById('priceDisplay').innerHTML = `
                    <div class="price-stat-value">$${formatNum(price, 2)}</div>
                    <div style="font-size: 0.8rem; line-height: 1.4; color: var(--text-muted);">
                        Price last updated:<br>
                        ${data.priceSummary?.lastCloseDate ? data.priceSummary.lastCloseDate.split('T')[0] : '--'} •<br>
                        official Daily Close<br>
                        Bullish And Foolish uses official EOD data from Nasdaq.
                    </div>
                `;

                // 2. Narrative & Points Cards (Filter out Filing signals)
                const narrative = data.narrative
                    || data.strategicOutlook?.narrative
                    || 'Balanced fundamentals without a single standout strength or weakness.';
                const fmtNarrative = narrative.replace(/((?:High\s*risk|Speculative):)/gi, '<br>$1');
                document.getElementById('narrativeDisplay').innerHTML = `"${fmtNarrative}"`;

                // === RISK ALERTS BOX ===
                const riskAlertsBox = document.getElementById('riskAlertsBox');
                const riskAlertsText = document.getElementById('riskAlertsText');
                const filingSignals = data.filingSignals || [];
                const criticalSignals = filingSignals.filter(s =>
                    ['going_concern', 'substantial_doubt', 'material_weakness', 'liquidity_shortage', 'reg_investigation', 'covenant_risk', 'reverse_split'].includes(s.id)
                );

                if (criticalSignals.length > 0) {
                    const signalNames = criticalSignals.slice(0, 3).map(s => s.title || s.id).join(', ');
                    riskAlertsText.textContent = `${criticalSignals.length} critical signal${criticalSignals.length > 1 ? 's' : ''} detected: ${signalNames}${criticalSignals.length > 3 ? '...' : ''}`;
                    riskAlertsBox.style.display = 'block';
                }

                // === VIEW ON SCREENER LINK ===
                const screenerLinkContainer = document.getElementById('screenerLinkContainer');
                const screenerLink = document.getElementById('screenerLink');
                // Build screener URL with highlight param - screener will scroll to this company
                const screenerUrl = `/screener.html?highlight=${encodeURIComponent(ticker)}`;
                screenerLink.href = screenerUrl;
                screenerLinkContainer.style.display = 'block';

                const warnings = [];
                if (annualMode) {
                    warnings.push({
                        title: 'Foreign Issuer',
                        text: 'This company files annual-only statements; ratings use year-on-year data.'
                    });
                }
                if (isClinicalStageBiotech) {
                    warnings.push({
                        title: 'Clinical Stage Biotech',
                        text: 'Traditional financial metrics have limited relevance. Outcomes depend on clinical trial results.'
                    });
                }

                const dataQuality = data.dataQuality || {};
                const mismatches = Array.isArray(dataQuality.materialMismatches) ? dataQuality.materialMismatches : [];
                const hasStaleData = mismatches.some(m => m.issue === 'Stale Data');
                if (hasStaleData) {
                    warnings.push({
                        title: 'Stale Data (>180d)',
                        text: 'Some financial statements are older than 180 days. Ratings may not reflect current conditions.'
                    });
                    // Visually restrain score (P0)
                    document.getElementById('scoreDisplay').style.opacity = '0.5';
                    document.getElementById('scoreDisplay').title = 'Rating restrained due to stale data';
                    document.getElementById('scoreDisplay').textContent += '*';
                    headerScore.style.opacity = '0.5';
                }

                const warningPanel = document.getElementById('warningPanel');
                const warningItems = document.getElementById('warningItems');
                const confidencePill = document.getElementById('confidencePill');
                const confidenceText = document.getElementById('confidenceText');
                const confidenceFill = document.getElementById('confidenceFill');
                const showConfidence = false;
                if (warnings.length) {
                    warningItems.innerHTML = warnings.map(w => `
                        <div class="warning-item">
                            <div class="warning-item-title">${w.title}</div>
                            <div class="warning-item-text">${w.text}</div>
                        </div>
                    `).join('');
                    warningPanel.style.display = '';
                } else {
                    warningPanel.style.display = 'none';
                }

                const confidenceScore = Number(data.confidenceMeta?.score ?? data.dataCompleteness?.percent);
                if (showConfidence && Number.isFinite(confidenceScore)) {
                    const clamped = Math.max(0, Math.min(100, Math.round(confidenceScore)));
                    const level = data.confidenceMeta?.level || (clamped >= 75 ? 'high' : clamped >= 45 ? 'medium' : 'low');
                    confidenceText.textContent = `Confidence: ${level} (${clamped}%)`;
                    confidenceFill.style.width = `${clamped}%`;
                    confidencePill.style.display = '';
                    if (warningPanel.style.display === 'none') warningPanel.style.display = '';
                } else if (confidencePill) {
                    confidencePill.style.display = 'none';
                }

                const filingSignalIds = new Set(['insider_trading_pattern', 'going_concern', 'material_weakness', 'substantial_doubt', 'liquidity_shortage', 'needs_financing', 'dilution_risk', 'covenant_risk', 'restatement']);

                const ratingReasons = (data.ratingReasons || [])
                    .filter(r => !r.missing && !r.notApplicable && r.score !== 0 && !filingSignalIds.has(r.id) && r.name.toLowerCase() !== 'filing signals')
                    .sort((a, b) => Math.abs(b.score) - Math.abs(a.score));

                document.getElementById('quickHighlights').innerHTML = ratingReasons.map(r => {
                    const scoreVal = Number(r.score) || 0;
                    const scoreText = formatScore(scoreVal);
                    const isPos = scoreVal > 0;
                    const isNeg = scoreVal < 0;
                    const typeClass = isPos ? 'positive' : (isNeg ? 'negative' : 'neutral');
                    const color = isPos ? 'var(--accent)' : (isNeg ? 'var(--danger)' : 'var(--warning)');

                    const explainer = ruleExplainers[r.name] ? (scoreVal >= 0 ? ruleExplainers[r.name].pos : ruleExplainers[r.name].neg) : '';

                    let displayName = r.name;

                    // Restore old naming convention (Strip YoY, TTM)
                    displayName = displayName
                        .replace(/ YoY/i, '')
                        .replace(/ TTM/i, '')
                        .replace(/ \(3Y\)/i, '');

                    // Ensure matching key for explainer even if renamed
                    const explainerKey = r.name;
                    const explanationText = ruleExplainers[explainerKey]
                        ? (scoreVal >= 0 ? ruleExplainers[explainerKey].pos : ruleExplainers[explainerKey].neg)
                        : (ruleExplainers[displayName] ? (scoreVal >= 0 ? ruleExplainers[displayName].pos : ruleExplainers[displayName].neg) : '');

                    const basisLabel = r.basisLabel || r.timeBasis || data.ratingBasis || 'Mixed';
                    const periodEnds = (r.sourcePeriods || [])
                        .map(p => p && p.periodEnd ? String(p.periodEnd) : '')
                        .filter(Boolean)
                        .sort();
                    const periodLabel = (() => {
                        if (!periodEnds.length) return '';
                        const start = periodEnds[0];
                        const end = periodEnds[periodEnds.length - 1];
                        if (start === end) return `As of ${end}`;
                        return `${start} -> ${end}`;
                    })();

                    return `
                            <div class="points-card ${typeClass}">
                                <div class="points-header">
                                    <span style="text-transform: capitalize;">${displayName}</span>
                                <span class="points-score" style="background: ${color}; color: var(--bg-primary);">${isPos ? '+' : ''}${scoreText}</span>
                            </div>
                            <p class="points-desc">${(r.message || '').replace(/\n/g, '<br>').replace(/(-?\d+(\.\d+)?%?|\$\d+(\.\d+)?[BMT]?)/g, '<strong>$1</strong>')}</p>
                            <div class="points-footer">
                                ${explanationText ? `<p class="points-explainer">${explanationText}</p>` : ''}
                                <div class="basis-pointer">Basis: ${basisLabel}</div>
                                ${periodLabel ? `<div class="period-pointer">Period: ${periodLabel}</div>` : ''}
                            </div>
                            ${hasStaleData ? `<div class="dq-badge">Stale Data (&gt;180d)</div>` : ''}
                            <div class="indicator-track">
                                <div class="indicator-fill" style="width: ${Math.min(100, Math.abs(scoreVal) * 10)}%; background: ${color};"></div>
                            </div>
                        </div>
                    `;
                }).join('');

                // 3. Strategic Outlook
                const outlook = data.strategicOutlook || {};

                // Op Momentum
                const op = outlook.operationalMomentum || {};
                document.getElementById('opMomentum').textContent = op.label || '--';
                document.getElementById('opMomentumDesc').textContent = op.narrative || '';

                if (op.score01 != null) {
                    const color = op.score01 >= 0.6 ? 'var(--accent)' : (op.score01 <= 0.4 ? 'var(--danger)' : 'var(--text-primary)');
                    document.getElementById('opMomentum').style.color = color;
                    document.getElementById('opMomentumBar').style.width = `${Math.min(100, op.score01 * 100)}%`;
                    document.getElementById('opMomentumBar').style.background = color;
                }

                // Trajectory
                const traj = outlook.trajectory || {};
                const trajLabel = traj.label || '--';
                document.getElementById('trajLabel').textContent = trajLabel;
                document.getElementById('trajText').textContent = traj.narrative || 'No detailed trajectory data.';

                const trajIcon = document.getElementById('trajIcon');
                const trajHint = document.getElementById('trajHint');
                const trajHintLabel = document.getElementById('trajHintLabel');
                const trajHintBody = document.getElementById('trajHintBody');

                function buildTrajectoryHint(payload, trajMeta) {
                    const labelRaw = String(trajMeta?.label || '').trim();
                    const label = labelRaw.toLowerCase();
                    const company = payload.companyName || 'The company';
                    const sector = payload.sectorBucket || payload.sector || 'its sector';
                    const op = payload.strategicOutlook?.operationalMomentum || {};
                    const opLabel = op.label ? `Operational momentum reads as ${op.label.toLowerCase()}.` : '';

                    let sentences = [];
                    if (label.includes('compound')) {
                        sentences = [
                            `${company} is compounding: steady progress without sharp reversals.`,
                            `Signals across ${sector} fundamentals are reinforcing each other, not spiking once.`,
                            `That pattern usually holds up best when growth and cash durability stay aligned.`
                        ];
                    } else if (label.includes('accelerat')) {
                        sentences = [
                            `${company} is improving faster than its recent baseline.`,
                            `Signals across ${sector} fundamentals are stacking rather than canceling out.`,
                            `If this pace persists, the score tends to settle at higher levels instead of fading.`
                        ];
                    } else if (label.includes('improv')) {
                        sentences = [
                            `${company} is making visible gains versus its recent base.`,
                            `Positive moves in ${sector} fundamentals are outnumbering the negatives.`,
                            `The next filings should confirm whether this is a durable step-up.`
                        ];
                    } else if (label.includes('recover')) {
                        sentences = [
                            `${company} is climbing out of a softer period, not fully normalized yet.`,
                            `The trajectory reads as early proof, but it still needs follow-through in ${sector}.`,
                            `Look for consistency across profitability and cash durability in upcoming filings.`
                        ];
                    } else if (label.includes('stall') || label.includes('cool')) {
                        sentences = [
                            `${company} is holding ground, but the pace of improvement is slowing.`,
                            `Fewer fresh positives from ${sector} fundamentals are landing in the score.`,
                            `Without new catalysts, the quality signal can drift sideways for a while.`
                        ];
                    } else if (label.includes('deterior') || label.includes('fall')) {
                        sentences = [
                            `${company} is losing traction versus its recent base.`,
                            `Negative shifts in ${sector} fundamentals are now outweighing the positives.`,
                            `If the next filings do not reverse this, the score can keep sliding.`
                        ];
                    } else if (label.includes('stable') || label.includes('flat') || label.includes('mixed') || label.includes('unclear')) {
                        sentences = [
                            `${company} is balancing positives and negatives without a clear winner.`,
                            `The signal mix in ${sector} looks steady but not decisive.`,
                            `A single strong or weak filing can move this quickly, so it reads as neutral.`
                        ];
                    } else if (labelRaw) {
                        sentences = [
                            `${company} is showing a ${labelRaw.toLowerCase()} pattern in the fundamentals.`,
                            `That suggests the ${sector} signal mix is tilting in one direction.`,
                            `We will keep adjusting as new filings land.`
                        ];
                    }

                    if (opLabel) {
                        sentences.push(opLabel);
                    }

                    return sentences;
                }

                if (trajLabel === 'Accelerating' || trajLabel === 'Improving' || trajLabel === 'Compounder') {
                    trajIcon.innerHTML = '▲';
                    trajIcon.style.color = 'var(--accent)';
                    document.getElementById('trajLabel').style.color = 'var(--accent)';
                } else if (trajLabel === 'Recovering') {
                    trajIcon.innerHTML = '▲';
                    trajIcon.style.color = 'var(--warning)';
                    document.getElementById('trajLabel').style.color = 'var(--warning)';
                } else if (trajLabel === 'Stalling' || trajLabel === 'Cooling') {
                    trajIcon.innerHTML = '&#9679;';
                    trajIcon.style.color = 'var(--warning)';
                    document.getElementById('trajLabel').style.color = 'var(--warning)';
                } else if (trajLabel === 'Deteriorating' || trajLabel === 'Falling') {
                    trajIcon.innerHTML = '▼';
                    trajIcon.style.color = 'var(--danger)';
                    document.getElementById('trajLabel').style.color = 'var(--danger)';
                } else {
                    trajIcon.innerHTML = '';
                    document.getElementById('trajLabel').style.color = 'var(--text-primary)';
                }

                if (trajHint && trajHintLabel && trajHintBody) {
                    if (trajLabel && trajLabel !== '--') {
                        trajHintLabel.textContent = trajLabel;
                        const sentences = buildTrajectoryHint(data, traj);
                        trajHintBody.textContent = sentences.join(' ');
                        trajHint.style.display = '';
                    } else {
                        trajHint.style.display = 'none';
                    }
                }

                // 4. Filing Signals (Detailed)
                const sigList = (data.filingSignals || [])
                    .filter(s => s.severity !== 'low')
                    .sort((a, b) => {
                        const aScore = Number(a.score) || 0;
                        const bScore = Number(b.score) || 0;
                        const aAbs = Math.abs(aScore);
                        const bAbs = Math.abs(bScore);
                        if (bAbs !== aAbs) return bAbs - aAbs;
                        return bScore - aScore;
                    })
                    .slice(0, 6);
                if (sigList.length === 0) {
                    document.getElementById('filingSignalsContainer').innerHTML = '<div class="text-muted">No major recent filing signals detected in the latest SEC docs.</div>';
                } else {
                    document.getElementById('filingSignalsContainer').innerHTML = sigList.map(sig => {
                        const scoreVal = Number(sig.score) || 0;
                        const isPos = scoreVal > 0;
                        const isNeg = scoreVal < 0;
                        const scoreText = formatScore(scoreVal);
                        const color = isPos ? 'var(--accent)' : (isNeg ? 'var(--danger)' : 'var(--warning)');
                        const badgeBg = isPos ? 'var(--accent-muted)' : (isNeg ? 'var(--danger-muted)' : 'var(--warning-muted)');
                        const title = String(sig.title || '')
                            .replace(/\s+Mentioned\b/i, '')
                            .trim();

                        return `
                            <div class="filing-card" style="border-top: 2px solid ${color};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-weight: 700; color: var(--text-primary); font-size: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 4px; margin-bottom: 4px;">
                                            ${title || sig.title}
                                        </div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">
                                            Filed: ${sig.filed} • Form ${sig.form}
                                        </div>
                                    </div>
                                    <div class="badge" style="background: ${badgeBg}; color: ${color};">
                                        Impact: ${isPos ? '+' : ''}${scoreText}
                                    </div>
                                </div>
                                <div class="filing-quote">
                                    "${sig.snippet || 'Significant phrasing detected in recent document.'}"
                                </div>
                                <a href="${sig.docUrl}" target="_blank" class="filing-link">
                                    View SEC Filing <span style="font-size: 1.1em;">↗</span>
                                </a>
                            </div>
                        `;
                    }).join('');
                }

                const biotechIds = new Set([
                    'clinical_positive',
                    'clinical_negative',
                    'safety_good',
                    'safety_bad',
                    'regulatory_positive',
                    'regulatory_negative',
                    'regulatory_setback',
                    'catalyst_upcoming',
                    'moa_strength',
                    'moa_weak',
                    'trial_execution_risk',
                    'biotech_cash_dependency',
                    'non_dilutive_finance'
                ]);

                const isBioCompany = (() => {
                    const sector = String(data.sectorBucket || data.sector || '').toLowerCase();
                    const sicDesc = String(data.filingProfile?.sicDescription || '').toLowerCase();
                    const name = String(data.companyName || '').toLowerCase();
                    return sector.includes('biotech') ||
                        sector.includes('pharma') ||
                        sicDesc.includes('pharmaceutical') ||
                        sicDesc.includes('biological') ||
                        sicDesc.includes('medicinal') ||
                        /\b(therapeutics|biopharma|oncology|biosciences)\b/i.test(name);
                })();

                const shownIds = new Set(sigList.map(sig => sig.id));
                const bioSignals = (data.filingSignals || []).filter(sig => biotechIds.has(sig.id) && !shownIds.has(sig.id));
                const bioSection = document.getElementById('bioIntelSection');
                const bioContainer = document.getElementById('bioIntelContainer');

                if (isBioCompany && bioSignals.length) {
                    bioContainer.innerHTML = bioSignals.map(sig => {
                        const scoreVal = Number(sig.score) || 0;
                        const isPos = scoreVal > 0;
                        const isNeg = scoreVal < 0;
                        const scoreText = formatScore(scoreVal);
                        const color = isPos ? 'var(--accent)' : (isNeg ? 'var(--danger)' : 'var(--warning)');
                        const badgeBg = isPos ? 'var(--accent-muted)' : (isNeg ? 'var(--danger-muted)' : 'var(--warning-muted)');
                        const snippet = sig.snippet || 'Biotech-specific signal detected in recent filing.';
                        return `
                            <div class="filing-card" style="border-top: 2px solid ${color};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                    <div>
                                        <div style="font-weight: 700; color: var(--text-primary); font-size: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 4px; margin-bottom: 4px;">
                                            ${sig.title || 'Biotech Signal'}
                                        </div>
                                        <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600;">
                                            Filed: ${sig.filed || 'n/a'} Form ${sig.form || 'n/a'}
                                        </div>
                                    </div>
                                    <div class="badge" style="background: ${badgeBg}; color: ${color};">
                                        Impact: ${isPos ? '+' : ''}${scoreText}
                                    </div>
                                </div>
                                <div class="filing-quote">
                                    "${snippet}"
                                </div>
                                ${sig.docUrl ? `<a href="${sig.docUrl}" target="_blank" class="filing-link">View SEC Filing <span style="font-size: 1.1em;">&#62;</span></a>` : ''}
                            </div>
                        `;
                    }).join('');
                    bioSection.style.display = '';
                } else {
                    bioSection.style.display = 'none';
                    bioContainer.innerHTML = '';
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                initScrollCue();
                stopLoadingNarrator();

                // Initial scroll check for sticky score
                handleScroll();
                window.addEventListener('scroll', handleScroll);

                function handleScroll() {
                    const heroScore = document.getElementById('scoreDisplay');
                    const stickyScore = document.getElementById('stickyScoreContainer');
                    const rect = heroScore.getBoundingClientRect();
                    // If hero score is out of view (above the viewport), show sticky score
                    if (rect.bottom < 0) {
                        stickyScore.style.display = 'flex';
                    } else {
                        stickyScore.style.display = 'none';
                    }
                }

            } catch (err) {
                stopLoadingNarrator('Could not load data.');
                document.getElementById('loading').innerHTML = `
                    <div class="badge badge-bearish">Error: ${err.message}</div>
                    <p class="text-muted" style="margin-top: var(--space-md);">Ensure "${ticker}" is valid and has data.</p>
                `;
            }
        }

        startLoadingNarrator();
        init();
    </script>
    <div id="scrollDownOverlay" class="scroll-down-overlay" aria-hidden="true">&darr;</div>
    <footer class="footer-disclaimer">
        <div class="container">
            <div class="disclaimer-text">
                <p style="font-weight: 600; margin-bottom: var(--space-sm); color: var(--text-primary);">Disclaimer &
                    Disclosure</p>
                <p>Bullish and Foolish is an independent financial analysis tool. All data is sourced from public SEC
                    filings.
                    The ratings and analysis provided are for informational purposes only and do NOT constitute
                    financial advice, investment recommendations, or an offer to buy/sell securities.
                    We are not a registered investment advisor.
                    Fundamental data can be subject to reporting lags or errors in source filings.
                    Past performance is not indicative of future results.
                    We make no representation or warranty as to the accuracy or completeness of the information.
                    Always perform your own due diligence before making investment decisions.</p>
                <p style="margin-top: var(--space-md);">
                    <strong>Open Source:</strong> This software is licensed under
                    <a href="https://www.gnu.org/licenses/agpl-3.0.html" target="_blank" rel="noopener">AGPL-3.0</a>.
                    <a href="https://github.com/freelancerbg71/bullish-and-foolish-live" target="_blank"
                        rel="noopener">View Source Code</a>.
                </p>
                <p style="margin-top: var(--space-sm);">&copy; 2025 Bullish and Foolish. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <div id="supportModal" class="modal-overlay" onclick="closeSupportModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>Keep the Signal Clean</h3>
            <p>
                Bullish & Foolish is an independent project.
                Your support helps cover the hosting and server costs that keep this tool fast, free, and ad-free for
                everyone.
            </p>
            <div class="modal-actions">
                <a href="https://revolut.me/viktorc8gv" target="_blank" class="modal-btn-primary"
                    onclick="closeSupportModal()">
                    Continue to Revolut
                </a>
                <button class="modal-btn-secondary" onclick="closeSupportModal()">Maybe later</button>
            </div>
        </div>
    </div>

    <!-- Supabase Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>

</html>
